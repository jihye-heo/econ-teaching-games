<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Externality Economics Game</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-database-compat.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tailwindcss-cdn@3.4.1/tailwindcss.js"></script>
</head>
<body>
  <div id="root"></div>

  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDt0_WzG8o2pecbuYTKRxGI3GDye7k9USg",
      authDomain: "externality-game.firebaseapp.com",
      databaseURL: "https://externality-game-default-rtdb.firebaseio.com",
      projectId: "externality-game",
      storageBucket: "externality-game.firebasestorage.app",
      messagingSenderId: "230260835239",
      appId: "1:230260835239:web:9cacc7579eacd0a5a62c82"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Game constants
    const PROFIT_PER_UNIT = 10;
    const EXTERNAL_COST_PER_UNIT = 0.5;
    const BASE_BILL = 50;
    const TOTAL_ROUNDS = 3;

    // State
    let state = {
      view: 'home',
      roomCode: '',
      playerName: '',
      playerId: '',
      currentRoom: null,
      isInstructor: false,
      production: 50
    };

    // Render
    function render() {
      const root = document.getElementById('root');
      
      if (state.view === 'home') {
        root.innerHTML = `
          <div class="min-h-screen bg-gradient-to-br from-blue-900 to-indigo-900 flex items-center justify-center p-4">
            <div class="max-w-2xl w-full bg-white rounded-2xl shadow-2xl p-8">
              <div class="text-center mb-8">
                <div class="text-6xl mb-4">‚ö°</div>
                <h1 class="text-4xl font-bold text-gray-800 mb-2">Externality Economics</h1>
                <p class="text-gray-600">Interactive datacenter simulation</p>
              </div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button onclick="goToInstructor()" class="bg-indigo-600 hover:bg-indigo-700 text-white p-6 rounded-xl">
                  <div class="text-4xl mb-2">üë®‚Äçüè´</div>
                  <div class="font-bold text-lg">Instructor</div>
                </button>
                <button onclick="goToStudent()" class="bg-green-600 hover:bg-green-700 text-white p-6 rounded-xl">
                  <div class="text-4xl mb-2">üéÆ</div>
                  <div class="font-bold text-lg">Student</div>
                </button>
              </div>
            </div>
          </div>
        `;
      } else if (state.view === 'instructor') {
        root.innerHTML = `
          <div class="min-h-screen bg-gradient-to-br from-blue-900 to-indigo-900 p-4">
            <div class="max-w-4xl mx-auto">
              <button onclick="goHome()" class="mb-4 text-white hover:text-blue-200">‚Üê Back</button>
              <div class="bg-white rounded-2xl shadow-2xl p-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Instructor Dashboard</h2>
                <button onclick="createRoom()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-semibold mb-6">
                  + Create New Room
                </button>
                <div id="rooms-list" class="space-y-4">
                  <p class="text-gray-500">Loading rooms...</p>
                </div>
              </div>
            </div>
          </div>
        `;
        loadRooms();
      } else if (state.view === 'student') {
        root.innerHTML = `
          <div class="min-h-screen bg-gradient-to-br from-blue-900 to-indigo-900 flex items-center justify-center p-4">
            <div class="max-w-md w-full bg-white rounded-2xl shadow-2xl p-8">
              <button onclick="goHome()" class="mb-4 text-gray-600 hover:text-gray-800">‚Üê Back</button>
              <h2 class="text-3xl font-bold text-gray-800 mb-6">Join Game</h2>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Your Name</label>
                  <input id="input-name" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Enter your name">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Room Code</label>
                  <input id="input-room" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Enter room code">
                </div>
                <button onclick="joinRoom()" class="w-full bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold">
                  Join Room
                </button>
              </div>
            </div>
          </div>
        `;
      } else if (state.view === 'lobby') {
        const players = state.currentRoom.players || {};
        const playerList = Object.values(players);
        root.innerHTML = `
          <div class="min-h-screen bg-gradient-to-br from-blue-900 to-indigo-900 flex items-center justify-center p-4">
            <div class="max-w-md w-full bg-white rounded-2xl shadow-2xl p-8 text-center">
              <div class="text-6xl mb-4 animate-pulse">‚ö°</div>
              <h2 class="text-3xl font-bold text-gray-800 mb-4">Welcome, ${state.playerName}!</h2>
              <p class="text-gray-600 mb-6">Waiting for instructor...</p>
              <div class="bg-indigo-50 rounded-lg p-4 mb-6">
                <div class="text-sm text-gray-600 mb-2">Room Code</div>
                <div class="text-3xl font-bold text-indigo-600">${state.currentRoom.code}</div>
              </div>
              <div class="text-left bg-gray-50 rounded-lg p-4">
                <div class="text-sm font-medium text-gray-700 mb-2">Players (${playerList.length}):</div>
                <ul class="space-y-1">
                  ${playerList.map(p => `<li class="text-sm text-gray-600">‚Ä¢ ${p.name} ${p.name === state.playerName ? '(you)' : ''}</li>`).join('')}
                </ul>
              </div>
            </div>
          </div>
        `;
      } else if (state.view === 'gameplay') {
        root.innerHTML = '<div class="min-h-screen bg-gray-900 text-white flex items-center justify-center"><h1 class="text-3xl">Game screen coming soon...</h1></div>';
      }
    }

    // Navigation
    window.goHome = () => { state.view = 'home'; render(); };
    window.goToInstructor = () => { state.view = 'instructor'; render(); };
    window.goToStudent = () => { state.view = 'student'; render(); };

    // Create room
    window.createRoom = async () => {
      const codes = ['ALPHA', 'BRAVO', 'CHARLIE', 'DELTA', 'ECHO', 'FOXTROT'];
      const code = codes[Math.floor(Math.random() * codes.length)] + Math.floor(Math.random() * 100);
      
      await db.ref(`rooms/${code}`).set({
        code,
        players: {},
        currentRound: 1,
        gameState: 'lobby'
      });
      
      alert(`Room created! Code: ${code}`);
      render();
    };

    // Load rooms
    function loadRooms() {
      db.ref('rooms').on('value', (snapshot) => {
        const data = snapshot.val();
        const list = document.getElementById('rooms-list');
        if (!list) return;
        
        if (!data) {
          list.innerHTML = '<p class="text-gray-500">No rooms yet.</p>';
          return;
        }
        
        list.innerHTML = Object.keys(data).map(code => {
          const room = data[code];
          const count = room.players ? Object.keys(room.players).length : 0;
          return `
            <div class="border rounded-lg p-4">
              <div class="flex justify-between items-center">
                <div>
                  <span class="text-2xl font-bold text-indigo-600">${code}</span>
                  <span class="ml-4 text-gray-600">${count} students</span>
                </div>
                <button onclick="startGameRoom('${code}')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">
                  Start Game
                </button>
              </div>
            </div>
          `;
        }).join('');
      });
    }

    // Join room
    window.joinRoom = async () => {
      const name = document.getElementById('input-name').value;
      const code = document.getElementById('input-room').value.toUpperCase();
      
      if (!name || !code) {
        alert('Please enter name and room code!');
        return;
      }
      
      const roomSnap = await db.ref(`rooms/${code}`).once('value');
      if (!roomSnap.exists()) {
        alert('Room not found!');
        return;
      }
      
      const playerId = Date.now().toString();
      await db.ref(`rooms/${code}/players/${playerId}`).set({
        id: playerId,
        name: name,
        production: 50,
        submitted: false,
        isEliminated: false
      });
      
      state.playerName = name;
      state.playerId = playerId;
      state.roomCode = code;
      state.view = 'lobby';
      
      // Listen to room
      db.ref(`rooms/${code}`).on('value', (snap) => {
        state.currentRoom = snap.val();
        if (state.currentRoom.gameState === 'playing') {
          state.view = 'gameplay';
        }
        render();
      });
      
      render();
    };

    // Start game
    window.startGameRoom = async (code) => {
      const roomSnap = await db.ref(`rooms/${code}`).once('value');
      const room = roomSnap.val();
      const count = room.players ? Object.keys(room.players).length : 0;
      
      if (count < 4) {
        alert('Need at least 4 players!');
        return;
      }
      
      await db.ref(`rooms/${code}`).update({ gameState: 'playing' });
      alert('Game started!');
    };

    // Initial render
    render();
  </script>
</body>
</html>