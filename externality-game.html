<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Externality Game</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-database-compat.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tailwindcss-cdn@3.4.1/tailwindcss.js"></script>
</head>
<body>
  <div id="root"></div>
  <script>
    firebase.initializeApp({
      apiKey: "AIzaSyDt0_WzG8o2pecbuYTKRxGI3GDye7k9USg",
      authDomain: "externality-game.firebaseapp.com",
      databaseURL: "https://externality-game-default-rtdb.firebaseio.com",
      projectId: "externality-game",
      storageBucket: "externality-game.firebasestorage.app",
      messagingSenderId: "230260835239",
      appId: "1:230260835239:web:9cacc7579eacd0a5a62c82"
    });
    var db = firebase.database();
    var state = { view: 'home', roomCode: '', playerName: '', playerId: '', currentRoom: null, production: 50 };

    function render() {
      var root = document.getElementById('root');
      if (state.view === 'home') {
        root.innerHTML = '<div class="min-h-screen bg-blue-900 flex items-center justify-center p-4"><div class="bg-white rounded-2xl p-8 max-w-2xl"><div class="text-center mb-8"><div class="text-6xl mb-4">‚ö°</div><h1 class="text-4xl font-bold mb-2">Externality Economics</h1></div><div class="grid grid-cols-2 gap-4"><button onclick="goInstructor()" class="bg-indigo-600 text-white p-6 rounded-xl"><div class="text-4xl mb-2">üë®‚Äçüè´</div><div class="font-bold">Instructor</div></button><button onclick="goStudent()" class="bg-green-600 text-white p-6 rounded-xl"><div class="text-4xl mb-2">üéÆ</div><div class="font-bold">Student</div></button></div></div></div>';
      } else if (state.view === 'instructor') {
        root.innerHTML = '<div class="min-h-screen bg-blue-900 p-4"><div class="max-w-4xl mx-auto"><button onclick="goHome()" class="mb-4 text-white">Back</button><div class="bg-white rounded-2xl p-8"><h2 class="text-3xl font-bold mb-6">Instructor Dashboard</h2><button onclick="createRoom()" class="bg-indigo-600 text-white px-6 py-3 rounded-lg mb-6">Create Room</button><div id="rooms-list">Loading...</div></div></div></div>';
        loadRooms();
      } else if (state.view === 'student') {
        root.innerHTML = '<div class="min-h-screen bg-blue-900 flex items-center justify-center p-4"><div class="bg-white rounded-2xl p-8 max-w-md"><button onclick="goHome()" class="mb-4">Back</button><h2 class="text-3xl font-bold mb-6">Join Game</h2><input id="input-name" type="text" placeholder="Your name" class="w-full px-4 py-2 border rounded-lg mb-4"><input id="input-room" type="text" placeholder="Room code" class="w-full px-4 py-2 border rounded-lg mb-4"><button onclick="joinRoom()" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg">Join</button></div></div>';
      } else if (state.view === 'lobby') {
        var players = state.currentRoom.players || {};
        var playerList = Object.values(players);
        var html = '<div class="min-h-screen bg-blue-900 flex items-center justify-center p-4"><div class="bg-white rounded-2xl p-8 text-center max-w-md"><div class="text-6xl mb-4">‚ö°</div><h2 class="text-3xl font-bold mb-4">Welcome!</h2><p class="mb-6">Waiting for instructor...</p><div class="bg-indigo-50 rounded-lg p-4 mb-6"><div class="text-sm mb-2">Room Code</div><div class="text-3xl font-bold text-indigo-600">' + state.currentRoom.code + '</div></div><div class="bg-gray-50 rounded-lg p-4"><div class="text-sm font-medium mb-2">Players: ' + playerList.length + '</div><ul>';
        for (var i = 0; i < playerList.length; i++) {
          html += '<li class="text-sm">' + playerList[i].name + '</li>';
        }
        html += '</ul></div></div></div>';
        root.innerHTML = html;
      } else if (state.view === 'tutorial') {
        root.innerHTML = '<div class="min-h-screen bg-purple-900 flex items-center justify-center p-4"><div class="bg-white rounded-2xl p-8 max-w-3xl"><div class="text-center mb-6"><div class="text-6xl mb-4">üè¢‚ö°</div><h1 class="text-4xl font-bold mb-2">AI Datacenter Game</h1></div><div class="bg-blue-50 rounded-lg p-6 mb-4 border-l-4 border-blue-500"><h2 class="font-bold text-xl mb-2">The Scenario</h2><p>AI datacenters use electricity. This creates negative externalities.</p></div><div class="bg-red-50 rounded-lg p-6 border-l-4 border-red-500"><h2 class="font-bold text-xl mb-2">Rules</h2><p>After each round, last place is eliminated.</p></div><p class="text-center text-gray-500 mt-8">Waiting for instructor...</p></div></div>';
      } else if (state.view === 'gameplay') {
        root.innerHTML = '<div style="padding:50px;background:white;"><h1>Round 1</h1><p>Room: ' + state.currentRoom.code + '</p><p>Gameplay screen works!</p></div>';
      }
    }

    window.goHome = function() { state.view = 'home'; render(); };
    window.goInstructor = function() { state.view = 'instructor'; render(); };
    window.goStudent = function() { state.view = 'student'; render(); };

    window.createRoom = async function() {
      var code = 'ALPHA' + Math.floor(Math.random() * 100);
      await db.ref('rooms/' + code).set({ code: code, players: {}, currentRound: 1, gameState: 'lobby' });
      alert('Room: ' + code);
      render();
    };

    function loadRooms() {
      db.ref('rooms').on('value', function(snap) {
        var data = snap.val();
        var list = document.getElementById('rooms-list');
        if (!list) return;
        if (!data) { list.innerHTML = 'No rooms'; return; }
        var html = '';
        Object.keys(data).forEach(function(code) {
          var room = data[code];
          var count = room.players ? Object.keys(room.players).length : 0;
          var gs = room.gameState || 'lobby';
          html += '<div class="border rounded p-4 mb-4"><div class="flex justify-between mb-2"><span class="text-2xl font-bold">' + code + '</span><span>' + count + ' students</span></div><div class="flex gap-2"><button onclick="startTut(\'' + code + '\')" class="px-4 py-2 rounded ' + (gs === 'lobby' ? 'bg-blue-600 text-white' : 'bg-gray-300') + '">Tutorial</button><button onclick="startR1(\'' + code + '\')" class="px-4 py-2 rounded ' + (gs === 'tutorial' ? 'bg-green-600 text-white' : 'bg-gray-300') + '">Round 1</button></div></div>';
        });
        list.innerHTML = html;
      });
    }

    window.joinRoom = async function() {
      var name = document.getElementById('input-name').value;
      var code = document.getElementById('input-room').value.toUpperCase();
      if (!name || !code) { alert('Enter name and code'); return; }
      var snap = await db.ref('rooms/' + code).once('value');
      if (!snap.exists()) { alert('Room not found'); return; }
      var playerId = Date.now().toString();
      await db.ref('rooms/' + code + '/players/' + playerId).set({ id: playerId, name: name, production: 50, submitted: false });
      state.playerName = name;
      state.playerId = playerId;
      state.roomCode = code;
      state.view = 'lobby';
      db.ref('rooms/' + code).on('value', function(s) {
        state.currentRoom = s.val();
        if (state.currentRoom.gameState === 'tutorial' && state.view === 'lobby') { state.view = 'tutorial'; render(); }
        else if (state.currentRoom.gameState === 'playing' && state.view === 'tutorial') { state.view = 'gameplay'; render(); }
      });
      render();
    };

    window.startTut = async function(code) { await db.ref('rooms/' + code).update({ gameState: 'tutorial' }); };
    window.startR1 = async function(code) { await db.ref('rooms/' + code).update({ gameState: 'playing', currentRound: 1 }); };

    render();
  </script>
</body>
</html>