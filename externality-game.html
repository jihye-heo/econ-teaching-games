<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Externality Economics Game</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.1/firebase-database-compat.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  <script>
    // Initialize Firebase
    firebase.initializeApp({
      apiKey: "AIzaSyDt0_WzG8o2pecbuYTKRxGI3GDye7k9USg",
      authDomain: "externality-game.firebaseapp.com",
      databaseURL: "https://externality-game-default-rtdb.firebaseio.com",
      projectId: "externality-game",
      storageBucket: "externality-game.firebasestorage.app",
      messagingSenderId: "230260835239",
      appId: "1:230260835239:web:9cacc7579eacd0a5a62c82"
    });
    
    const db = firebase.database();
    
    // Game constants
    const REVENUE_PER_UNIT = 10;
    const COST_PER_UNIT = 3;
    const BASE_BILL = 50;
    const EXTERNAL_COST_PER_UNIT = 0.5;
    const TOTAL_ROUNDS = 3;
    
    // State management
    let state = {
      view: 'home',
      roomCode: '',
      playerName: '',
      playerId: '',
      currentRoom: null,
      production: 50,
      isInstructor: false
    };

    // Utility functions
    function generateRoomCode() {
      const codes = ['ALPHA', 'BRAVO', 'CHARLIE', 'DELTA', 'ECHO', 'FOXTROT'];
      return codes[Math.floor(Math.random() * codes.length)] + Math.floor(Math.random() * 100);
    }

    function calculateElectricityBill(totalProduction) {
      return BASE_BILL + (totalProduction * EXTERNAL_COST_PER_UNIT);
    }

    function calculateProfit(production, electricityBill) {
      const revenue = production * REVENUE_PER_UNIT;
      const totalCost = production * COST_PER_UNIT;
      return revenue - totalCost - electricityBill;
    }

    // Navigation functions
    window.goHome = function() {
      state.view = 'home';
      state.currentRoom = null;
      state.isInstructor = false;
      render();
    };

    window.goInstructor = function() {
      state.view = 'instructor';
      state.isInstructor = true;
      render();
    };

    window.goStudent = function() {
      state.view = 'student';
      render();
    };

    // Instructor functions
    window.createRoom = async function() {
      const code = generateRoomCode();
      await db.ref('rooms/' + code).set({
        code: code,
        players: {},
        currentRound: 1,
        gameState: 'lobby',
        roundResults: {}
      });
      alert('Room created: ' + code);
      render();
    };

    window.startPhase = async function(code, phase) {
      const validPhases = ['tutorial', 'round1', 'result1', 'round2', 'result2', 'round3', 'result3', 'final'];
      if (!validPhases.includes(phase)) return;
      
      // Reset player submissions when starting a new round
      if (phase.startsWith('round')) {
        const snapshot = await db.ref('rooms/' + code + '/players').once('value');
        const players = snapshot.val() || {};
        Object.keys(players).forEach(async (pid) => {
          await db.ref('rooms/' + code + '/players/' + pid).update({
            submitted: false,
            production: 50,
            readyForNext: false
          });
        });
      }
      
      // Calculate and store results when moving to result phase
      if (phase.startsWith('result')) {
        await calculateAndStoreResults(code);
      }
      
      await db.ref('rooms/' + code).update({ 
        gameState: phase,
        currentRound: phase.includes('1') ? 1 : phase.includes('2') ? 2 : phase.includes('3') ? 3 : 1
      });
    };

    async function calculateAndStoreResults(code) {
      const snapshot = await db.ref('rooms/' + code).once('value');
      const room = snapshot.val();
      const players = room.players || {};
      const currentRound = room.currentRound || 1;
      
      // Calculate total production
      let totalProduction = 0;
      Object.values(players).forEach(p => {
        totalProduction += p.production || 0;
      });
      
      const electricityBill = calculateElectricityBill(totalProduction);
      
      // Calculate results for each player
      const results = [];
      Object.values(players).forEach(p => {
        const profit = calculateProfit(p.production, electricityBill);
        results.push({
          id: p.id,
          name: p.name,
          production: p.production,
          revenue: p.production * REVENUE_PER_UNIT,
          totalCost: p.production * COST_PER_UNIT,
          electricityBill: electricityBill,
          profit: profit
        });
      });
      
      // Sort by profit (highest first)
      results.sort((a, b) => b.profit - a.profit);
      
      // Store results
      await db.ref('rooms/' + code + '/roundResults/round' + currentRound).set({
        totalProduction: totalProduction,
        electricityBill: electricityBill,
        results: results
      });
    }

    function loadRooms() {
      db.ref('rooms').on('value', function(snap) {
        const data = snap.val();
        const list = document.getElementById('rooms-list');
        if (!list) return;
        if (!data) {
          list.innerHTML = '<p class="text-gray-500">No rooms created yet</p>';
          return;
        }
        
        let html = '';
        Object.keys(data).forEach(function(code) {
          const room = data[code];
          const players = room.players || {};
          const count = Object.keys(players).length;
          const gameState = room.gameState || 'lobby';
          
          // Check readiness indicators
          const allSubmitted = Object.values(players).every(p => p.submitted);
          const allReady = Object.values(players).every(p => p.readyForNext);
          const hasPlayers = count > 0;
          
          html += '<div class="border border-gray-300 rounded-lg p-4 mb-4">';
          html += '<div class="flex justify-between items-center mb-3">';
          html += '<div>';
          html += '<span class="text-2xl font-bold text-indigo-600">' + code + '</span>';
          html += '<span class="ml-4 text-gray-600">' + count + ' students</span>';
          html += '</div>';
          html += '<div class="text-sm text-gray-500">State: ' + gameState + '</div>';
          html += '</div>';
          
          html += '<div class="flex flex-wrap gap-2">';
          
          // Tutorial button
          html += '<button onclick="startPhase(\'' + code + '\', \'tutorial\')" class="px-3 py-1 rounded text-sm ' + 
            (gameState === 'lobby' && hasPlayers ? 'bg-blue-600 text-white hover:bg-blue-700' : 'bg-gray-300 text-gray-600') + 
            '" ' + (!hasPlayers ? 'disabled' : '') + '>Tutorial</button>';
          
          // Round 1 button
          html += '<button onclick="startPhase(\'' + code + '\', \'round1\')" class="px-3 py-1 rounded text-sm ' + 
            (gameState === 'tutorial' ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-gray-300 text-gray-600') + 
            '">Round 1</button>';
          
          // Result 1 button
          html += '<button onclick="startPhase(\'' + code + '\', \'result1\')" class="px-3 py-1 rounded text-sm ' + 
            (gameState === 'round1' && allSubmitted ? 'bg-green-600 text-white hover:bg-green-700' : 
             gameState === 'round1' ? 'bg-yellow-500 text-white' : 'bg-gray-300 text-gray-600') + 
            '">Result 1</button>';
          
          // Round 2 button
          html += '<button onclick="startPhase(\'' + code + '\', \'round2\')" class="px-3 py-1 rounded text-sm ' + 
            (gameState === 'result1' && allReady ? 'bg-green-600 text-white hover:bg-green-700' : 
             gameState === 'result1' ? 'bg-yellow-500 text-white' : 'bg-gray-300 text-gray-600') + 
            '">Round 2</button>';
          
          // Result 2 button
          html += '<button onclick="startPhase(\'' + code + '\', \'result2\')" class="px-3 py-1 rounded text-sm ' + 
            (gameState === 'round2' && allSubmitted ? 'bg-green-600 text-white hover:bg-green-700' : 
             gameState === 'round2' ? 'bg-yellow-500 text-white' : 'bg-gray-300 text-gray-600') + 
            '">Result 2</button>';
          
          // Round 3 button
          html += '<button onclick="startPhase(\'' + code + '\', \'round3\')" class="px-3 py-1 rounded text-sm ' + 
            (gameState === 'result2' && allReady ? 'bg-green-600 text-white hover:bg-green-700' : 
             gameState === 'result2' ? 'bg-yellow-500 text-white' : 'bg-gray-300 text-gray-600') + 
            '">Round 3</button>';
          
          // Result 3 button
          html += '<button onclick="startPhase(\'' + code + '\', \'result3\')" class="px-3 py-1 rounded text-sm ' + 
            (gameState === 'round3' && allSubmitted ? 'bg-green-600 text-white hover:bg-green-700' : 
             gameState === 'round3' ? 'bg-yellow-500 text-white' : 'bg-gray-300 text-gray-600') + 
            '">Result 3</button>';
          
          // Final Summary button
          html += '<button onclick="startPhase(\'' + code + '\', \'final\')" class="px-3 py-1 rounded text-sm ' + 
            (gameState === 'result3' && allReady ? 'bg-green-600 text-white hover:bg-green-700' : 
             gameState === 'result3' ? 'bg-yellow-500 text-white' : 'bg-gray-300 text-gray-600') + 
            '">Final</button>';
          
          html += '</div>';
          
          // Submission status
          if (gameState.startsWith('round')) {
            const submitted = Object.values(players).filter(p => p.submitted).length;
            html += '<div class="mt-2 text-sm text-gray-600">Submitted: ' + submitted + '/' + count + '</div>';
          }
          if (gameState.startsWith('result')) {
            const ready = Object.values(players).filter(p => p.readyForNext).length;
            html += '<div class="mt-2 text-sm text-gray-600">Ready: ' + ready + '/' + count + '</div>';
          }
          
          html += '</div>';
        });
        list.innerHTML = html;
      });
    }

    // Student functions
    window.joinRoom = async function() {
      const name = document.getElementById('input-name').value.trim();
      const code = document.getElementById('input-room').value.toUpperCase().trim();
      
      if (!name || !code) {
        alert('Please enter both name and room code');
        return;
      }
      
      const snapshot = await db.ref('rooms/' + code).once('value');
      if (!snapshot.exists()) {
        alert('Room not found!');
        return;
      }
      
      const room = snapshot.val();
      const players = room.players || {};
      
      // Check if player already exists
      let playerId = null;
      Object.keys(players).forEach(pid => {
        if (players[pid].name === name) {
          playerId = pid;
        }
      });
      
      if (playerId) {
        alert('Rejoining as ' + name);
      } else {
        playerId = Date.now().toString();
        await db.ref('rooms/' + code + '/players/' + playerId).set({
          id: playerId,
          name: name,
          production: 50,
          submitted: false,
          readyForNext: false
        });
      }
      
      state.playerName = name;
      state.playerId = playerId;
      state.roomCode = code;
      state.view = 'lobby';
      
      // Listen to room changes
      db.ref('rooms/' + code).on('value', function(s) {
        const newRoom = s.val();
        if (!newRoom) return;
        
        state.currentRoom = newRoom;
        
        // Update view based on game state
        if (newRoom.gameState === 'tutorial' && state.view === 'lobby') {
          state.view = 'tutorial';
          render();
        } else if (newRoom.gameState.startsWith('round') && !state.view.startsWith('round')) {
          state.view = 'gameplay';
          state.production = 50;
          render();
        } else if (newRoom.gameState.startsWith('result') && !state.view.startsWith('result')) {
          state.view = 'results';
          render();
        } else if (newRoom.gameState === 'final' && state.view !== 'final') {
          state.view = 'final';
          render();
        } else {
          render();
        }
      });
      
      render();
    };

    window.submitProduction = async function() {
      if (!state.playerId || !state.roomCode) return;
      
      await db.ref('rooms/' + state.roomCode + '/players/' + state.playerId).update({
        production: state.production,
        submitted: true
      });
      
      render();
    };

    window.readyForNext = async function() {
      if (!state.playerId || !state.roomCode) return;
      
      await db.ref('rooms/' + state.roomCode + '/players/' + state.playerId).update({
        readyForNext: true
      });
      
      render();
    };

    // Render functions
    function render() {
      const root = document.getElementById('root');
      
      if (state.view === 'home') {
        renderHome(root);
      } else if (state.view === 'instructor') {
        renderInstructor(root);
      } else if (state.view === 'student') {
        renderStudentJoin(root);
      } else if (state.view === 'lobby') {
        renderLobby(root);
      } else if (state.view === 'tutorial') {
        renderTutorial(root);
      } else if (state.view === 'gameplay') {
        renderGameplay(root);
      } else if (state.view === 'results') {
        renderResults(root);
      } else if (state.view === 'final') {
        renderFinal(root);
      }
    }

    function renderHome(root) {
      root.innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-blue-900 via-blue-800 to-indigo-900 flex items-center justify-center p-4">
          <div class="max-w-2xl w-full bg-white rounded-2xl shadow-2xl p-8">
            <div class="text-center mb-8">
              <div class="text-6xl mb-4">⚡</div>
              <h1 class="text-4xl font-bold text-gray-800 mb-2">Externality Economics</h1>
              <p class="text-gray-600">Learn about market externalities through an interactive datacenter simulation</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <button onclick="goInstructor()" class="bg-indigo-600 hover:bg-indigo-700 text-white p-6 rounded-xl transition-all transform hover:scale-105">
                <div class="text-4xl mb-2">👨‍🏫</div>
                <div class="font-bold text-lg">Instructor</div>
                <div class="text-sm opacity-90">Create and manage rooms</div>
              </button>
              
              <button onclick="goStudent()" class="bg-green-600 hover:bg-green-700 text-white p-6 rounded-xl transition-all transform hover:scale-105">
                <div class="text-4xl mb-2">🎮</div>
                <div class="font-bold text-lg">Student</div>
                <div class="text-sm opacity-90">Join a room with code</div>
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderInstructor(root) {
      root.innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-blue-900 via-blue-800 to-indigo-900 p-4">
          <div class="max-w-6xl mx-auto">
            <button onclick="goHome()" class="mb-4 text-white hover:text-blue-200">← Back to Home</button>
            
            <div class="bg-white rounded-2xl shadow-2xl p-8">
              <h2 class="text-3xl font-bold text-gray-800 mb-6">Instructor Dashboard</h2>
              
              <button onclick="createRoom()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-semibold mb-6">
                + Create New Room
              </button>
              
              <div class="mb-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                <p class="text-sm text-gray-700"><strong>Button Colors:</strong></p>
                <ul class="text-sm text-gray-600 mt-2 space-y-1">
                  <li>🟢 <strong>Green:</strong> Ready to proceed (all students submitted/ready)</li>
                  <li>🟡 <strong>Yellow:</strong> Waiting for students</li>
                  <li>⚫ <strong>Gray:</strong> Not available yet</li>
                </ul>
              </div>
              
              <div id="rooms-list">Loading rooms...</div>
            </div>
          </div>
        </div>
      `;
      loadRooms();
    }

    function renderStudentJoin(root) {
      root.innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-blue-900 via-blue-800 to-indigo-900 flex items-center justify-center p-4">
          <div class="max-w-md w-full bg-white rounded-2xl shadow-2xl p-8">
            <button onclick="goHome()" class="mb-4 text-gray-600 hover:text-gray-800">← Back</button>
            
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Join Game</h2>
            
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Your Name</label>
                <input id="input-name" type="text" placeholder="Enter your name" 
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Room Code</label>
                <input id="input-room" type="text" placeholder="Enter room code" 
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                  style="text-transform: uppercase">
              </div>
              
              <button onclick="joinRoom()" class="w-full bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold">
                Join Room
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderLobby(root) {
      const room = state.currentRoom;
      const players = room.players || {};
      const playerList = Object.values(players);
      
      root.innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-blue-900 via-blue-800 to-indigo-900 flex items-center justify-center p-4">
          <div class="max-w-md w-full bg-white rounded-2xl shadow-2xl p-8 text-center">
            <div class="text-6xl mb-4 animate-pulse">⚡</div>
            <h2 class="text-3xl font-bold text-gray-800 mb-4">Welcome, ${state.playerName}!</h2>
            <p class="text-gray-600 mb-6">Waiting for instructor to start the game...</p>
            
            <div class="bg-indigo-50 rounded-lg p-4 mb-6">
              <div class="text-sm text-gray-600 mb-2">Room Code</div>
              <div class="text-3xl font-bold text-indigo-600">${room.code}</div>
            </div>
            
            <div class="text-left bg-gray-50 rounded-lg p-4">
              <div class="text-sm font-medium text-gray-700 mb-2">
                Players in room (${playerList.length}):
              </div>
              <ul class="space-y-1">
                ${playerList.map(p => `
                  <li class="text-sm text-gray-600">
                    • ${p.name} ${p.name === state.playerName ? '(you)' : ''}
                  </li>
                `).join('')}
              </ul>
            </div>
          </div>
        </div>
      `;
    }

    function renderTutorial(root) {
      root.innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-indigo-900 via-purple-900 to-blue-900 flex items-center justify-center p-4">
          <div class="max-w-3xl w-full bg-white rounded-2xl shadow-2xl p-8">
            <div class="text-center mb-6">
              <div class="text-6xl mb-4">🏢⚡</div>
              <h1 class="text-4xl font-bold text-gray-800 mb-2">Welcome to the AI Datacenter Game</h1>
              <p class="text-lg text-gray-600">Understanding Negative Externalities Through Competition</p>
            </div>

            <div class="space-y-6 text-gray-700">
              <div class="bg-blue-50 rounded-lg p-6 border-l-4 border-blue-500">
                <h2 class="font-bold text-xl text-blue-900 mb-3">🌍 The Scenario</h2>
                <p>AI companies are building massive datacenters that use huge amounts of electricity. 
                The cost of this electricity consumption is spread across neighborhoods, affecting everyone. 
                This is a <strong>negative externality</strong> - when your actions impose costs on others.</p>
              </div>

              <div class="bg-green-50 rounded-lg p-6 border-l-4 border-green-500">
                <h2 class="font-bold text-xl text-green-900 mb-3">🎮 Your Role</h2>
                <p>You are each a datacenter operator producing AI services for customers. 
                <strong>If you produce more, you earn more revenue</strong> - but you also have higher costs 
                and use more electricity, which <strong>increases electricity bills for everyone</strong> (including yourself!).</p>
              </div>

              <div class="bg-yellow-50 rounded-lg p-6 border-l-4 border-yellow-500">
                <h2 class="font-bold text-xl text-yellow-900 mb-3">⚖️ The Economics</h2>
                <ul class="space-y-2 ml-4">
                  <li>• <strong>Revenue:</strong> $10 per unit produced</li>
                  <li>• <strong>Your Production Cost:</strong> $3 per unit</li>
                  <li>• <strong>Electricity Bill:</strong> Shared cost based on everyone's total production</li>
                  <li>• <strong>Profit = Revenue - Cost - Electricity Bill</strong></li>
                </ul>
              </div>

              <div class="bg-purple-50 rounded-lg p-6 border-l-4 border-purple-500">
                <h2 class="font-bold text-xl text-purple-900 mb-3">🤔 The Question</h2>
                <p>Will you cooperate to keep electricity costs low for everyone? Or will competition drive you 
                to overproduce, creating a <strong>tragedy of the commons</strong>? Let's find out!</p>
              </div>
            </div>

            <div class="mt-8 text-center">
              <p class="text-gray-500">Waiting for instructor to start Round 1...</p>
            </div>
          </div>
        </div>
      `;
    }

    function renderGameplay(root) {
      const room = state.currentRoom;
      const players = room.players || {};
      const myPlayer = players[state.playerId] || { production: 50, submitted: false };
      
      // Calculate preview values
      const revenue = state.production * REVENUE_PER_UNIT;
      const totalCost = state.production * COST_PER_UNIT;
      const estimatedBill = BASE_BILL; // We can't know final bill until all submit
      
      root.innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-4">
          <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
              <div class="flex justify-between items-center">
                <div>
                  <span class="text-sm text-gray-600">Room: ${room.code}</span>
                  <span class="ml-4 font-bold text-lg">Round ${room.currentRound}/${TOTAL_ROUNDS}</span>
                </div>
                <div class="text-sm text-gray-600">
                  Submitted: ${Object.values(players).filter(p => p.submitted).length}/${Object.keys(players).length}
                </div>
              </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-8">
              <div class="flex items-center mb-6">
                <span class="text-3xl mr-3">⚡</span>
                <h3 class="text-2xl font-bold">Your Datacenter</h3>
              </div>

              <div class="mb-6">
                <label class="block text-lg font-medium text-gray-700 mb-3">
                  Production Level: <span id="prod-value" class="text-indigo-600 font-bold">${state.production}</span> units
                </label>
                <input id="prod-slider" type="range" min="0" max="100" value="${state.production}" 
                  ${myPlayer.submitted ? 'disabled' : ''}
                  class="w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600">
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                  <span>0</span>
                  <span>25</span>
                  <span>50</span>
                  <span>75</span>
                  <span>100</span>
                </div>
              </div>

              <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-6 space-y-4">
                <div class="flex justify-between items-center pb-3 border-b border-gray-300">
                  <span class="text-gray-700 font-medium">Revenue:</span>
                  <span id="revenue-val" class="text-xl font-bold text-green-600">$${revenue}</span>
                </div>
                
                <div class="flex justify-between items-center pb-3 border-b border-gray-300">
                  <span class="text-gray-700 font-medium">Total Cost (excl. electricity):</span>
                  <span id="cost-val" class="text-xl font-bold text-red-600">-$${totalCost}</span>
                </div>
                
                <div class="flex justify-between items-center pb-3 border-b border-gray-300">
                  <span class="text-gray-700 font-medium">Electricity Bill:</span>
                  <span class="text-xl font-bold text-orange-600">TBD after all submit</span>
                </div>
                
                <div class="flex justify-between items-center pt-2">
                  <span class="text-lg font-bold text-gray-800">Estimated Profit:</span>
                  <span id="profit-val" class="text-2xl font-bold text-indigo-600">$${revenue - totalCost} - Bill</span>
                </div>
                
                <p class="text-sm text-gray-500 italic mt-2">
                  * Final profit will be calculated after everyone submits, based on total production
                </p>
              </div>

              <button id="submit-btn" onclick="submitProduction()" 
                ${myPlayer.submitted ? 'disabled' : ''}
                class="w-full mt-6 px-6 py-4 rounded-lg font-semibold text-lg transition-all ${
                  myPlayer.submitted 
                    ? 'bg-gray-300 text-gray-600 cursor-not-allowed' 
                    : 'bg-indigo-600 hover:bg-indigo-700 text-white transform hover:scale-105'
                }">
                ${myPlayer.submitted ? '✓ Choice Submitted - Waiting for Others' : 'Submit Production Choice'}
              </button>
            </div>
          </div>
        </div>
      `;

      // Add event listener for slider
      setTimeout(() => {
        const slider = document.getElementById('prod-slider');
        if (slider && !myPlayer.submitted) {
          slider.oninput = function() {
            const val = Number(this.value);
            state.production = val;
            const revenue = val * REVENUE_PER_UNIT;
            const cost = val * COST_PER_UNIT;
            
            document.getElementById('prod-value').textContent = val;
            document.getElementById('revenue-val').textContent = '$' + revenue;
            document.getElementById('cost-val').textContent = '-$' + cost;
            document.getElementById('profit-val').textContent = '$' + (revenue - cost) + ' - Bill';
          };
        }
      }, 100);
    }

    function renderResults(root) {
      const room = state.currentRoom;
      const roundNum = room.currentRound;
      const results = room.roundResults['round' + roundNum];
      
      if (!results) {
        root.innerHTML = '<div class="min-h-screen flex items-center justify-center"><p>Loading results...</p></div>';
        return;
      }
      
      const myResult = results.results.find(r => r.id === state.playerId);
      const myPlayer = room.players[state.playerId];
      const isReady = myPlayer?.readyForNext || false;
      
      root.innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-purple-900 via-purple-800 to-indigo-900 p-4">
          <div class="max-w-5xl mx-auto">
            <div class="bg-white rounded-2xl shadow-2xl p-8">
              <h2 class="text-4xl font-bold text-gray-800 mb-2 text-center">
                Round ${roundNum} Results
              </h2>
              <p class="text-center text-gray-600 mb-8">How did your production choices affect everyone?</p>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="bg-indigo-50 rounded-lg p-4 text-center border-2 border-indigo-200">
                  <div class="text-sm text-gray-600 mb-1">Total Production</div>
                  <div class="text-3xl font-bold text-indigo-600">${results.totalProduction}</div>
                  <div class="text-xs text-gray-500">units</div>
                </div>
                
                <div class="bg-red-50 rounded-lg p-4 text-center border-2 border-red-200">
                  <div class="text-sm text-gray-600 mb-1">Electricity Bill</div>
                  <div class="text-3xl font-bold text-red-600">$${results.electricityBill.toFixed(0)}</div>
                  <div class="text-xs text-gray-500">per firm</div>
                </div>

                ${myResult ? `
                <div class="bg-green-50 rounded-lg p-4 text-center border-2 border-green-200">
                  <div class="text-sm text-gray-600 mb-1">Your Profit</div>
                  <div class="text-3xl font-bold ${myResult.profit > 0 ? 'text-green-600' : 'text-red-600'}">
                    $${myResult.profit.toFixed(0)}
                  </div>
                  <div class="text-xs text-gray-500">this round</div>
                </div>
                ` : ''}
              </div>

              <div class="bg-gray-50 rounded-lg p-6 mb-6">
                <h3 class="text-xl font-bold mb-4 text-gray-800">📊 Detailed Results</h3>
                
                <div class="overflow-x-auto">
                  <table class="w-full">
                    <thead>
                      <tr class="border-b-2 border-gray-300">
                        <th class="text-left py-3 px-2">Rank</th>
                        <th class="text-left py-3 px-2">Player</th>
                        <th class="text-right py-3 px-2">Production</th>
                        <th class="text-right py-3 px-2">Revenue</th>
                        <th class="text-right py-3 px-2">Cost</th>
                        <th class="text-right py-3 px-2">Elec. Bill</th>
                        <th class="text-right py-3 px-2 font-bold">Profit</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${results.results.map((r, i) => `
                        <tr class="border-b border-gray-200 ${r.id === state.playerId ? 'bg-indigo-100' : 'hover:bg-gray-100'}">
                          <td class="py-3 px-2 font-bold text-gray-600">#${i + 1}</td>
                          <td class="py-3 px-2 font-medium">
                            ${r.name}
                            ${r.id === state.playerId ? '<span class="text-xs text-indigo-600 ml-1">(You)</span>' : ''}
                          </td>
                          <td class="text-right py-3 px-2">${r.production}</td>
                          <td class="text-right py-3 px-2 text-green-600">$${r.revenue}</td>
                          <td class="text-right py-3 px-2 text-red-600">-$${r.totalCost}</td>
                          <td class="text-right py-3 px-2 text-orange-600">-$${r.electricityBill.toFixed(0)}</td>
                          <td class="text-right py-3 px-2 font-bold ${r.profit > 0 ? 'text-green-600' : 'text-red-600'}">
                            $${r.profit.toFixed(0)}
                          </td>
                        </tr>
                      `).join('')}
                      <tr class="bg-gray-200 font-bold">
                        <td colspan="2" class="py-3 px-2">TOTAL</td>
                        <td class="text-right py-3 px-2">${results.totalProduction}</td>
                        <td class="text-right py-3 px-2 text-green-600">$${results.results.reduce((sum, r) => sum + r.revenue, 0)}</td>
                        <td class="text-right py-3 px-2 text-red-600">-$${results.results.reduce((sum, r) => sum + r.totalCost, 0)}</td>
                        <td class="text-right py-3 px-2 text-orange-600">-$${(results.electricityBill * results.results.length).toFixed(0)}</td>
                        <td class="text-right py-3 px-2 ${results.results.reduce((sum, r) => sum + r.profit, 0) > 0 ? 'text-green-600' : 'text-red-600'}">
                          $${results.results.reduce((sum, r) => sum + r.profit, 0).toFixed(0)}
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="bg-blue-50 rounded-lg p-6 border-l-4 border-blue-500 mb-6">
                <h3 class="font-bold text-lg text-blue-900 mb-2">💡 What Happened?</h3>
                <p class="text-gray-700">
                  The total production was <strong>${results.totalProduction} units</strong>, which created an 
                  electricity bill of <strong>$${results.electricityBill.toFixed(0)}</strong> for each firm. 
                  This is a <strong>negative externality</strong> - your production decisions affected everyone's costs!
                </p>
              </div>

              <button onclick="readyForNext()" 
                ${isReady ? 'disabled' : ''}
                class="w-full px-6 py-4 rounded-lg font-semibold text-lg transition-all ${
                  isReady 
                    ? 'bg-gray-300 text-gray-600 cursor-not-allowed' 
                    : 'bg-green-600 hover:bg-green-700 text-white transform hover:scale-105'
                }">
                ${isReady ? '✓ Ready - Waiting for Other Players' : 'Ready for Next Round'}
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderFinal(root) {
      const room = state.currentRoom;
      const roundResults = room.roundResults || {};
      
      // Aggregate all rounds
      const playerTotals = {};
      const roundData = [];
      
      for (let i = 1; i <= 3; i++) {
        const round = roundResults['round' + i];
        if (round) {
          roundData.push(round);
          round.results.forEach(r => {
            if (!playerTotals[r.id]) {
              playerTotals[r.id] = {
                id: r.id,
                name: r.name,
                totalProfit: 0,
                totalProduction: 0,
                rounds: []
              };
            }
            playerTotals[r.id].totalProfit += r.profit;
            playerTotals[r.id].totalProduction += r.production;
            playerTotals[r.id].rounds.push({
              round: i,
              production: r.production,
              profit: r.profit
            });
          });
        }
      }
      
      const finalStandings = Object.values(playerTotals).sort((a, b) => b.totalProfit - a.totalProfit);
      const totalProductionAllRounds = roundData.reduce((sum, r) => sum + r.totalProduction, 0);
      const avgProductionPerRound = totalProductionAllRounds / roundData.length;
      const avgBillPerRound = roundData.reduce((sum, r) => sum + r.electricityBill, 0) / roundData.length;
      
      root.innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-green-900 via-blue-900 to-purple-900 p-4">
          <div class="max-w-6xl mx-auto">
            <div class="bg-white rounded-2xl shadow-2xl p-8">
              <h1 class="text-5xl font-bold text-center text-gray-800 mb-2">
                Game Complete! 🎉
              </h1>
              <p class="text-center text-gray-600 mb-8">
                Final results after ${TOTAL_ROUNDS} rounds
              </p>

              <div class="bg-gradient-to-r from-yellow-50 to-amber-50 rounded-lg p-6 mb-8 border-2 border-yellow-300">
                <h3 class="text-2xl font-bold text-center text-gray-800 mb-4">🏆 Winner</h3>
                <div class="text-center">
                  <div class="text-4xl font-bold text-amber-600 mb-2">${finalStandings[0]?.name || 'N/A'}</div>
                  <div class="text-xl text-gray-600">Total Profit: $${finalStandings[0]?.totalProfit.toFixed(0) || '0'}</div>
                </div>
              </div>

              <div class="bg-gray-50 rounded-lg p-6 mb-8">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">📊 Final Standings</h3>
                <div class="space-y-3">
                  ${finalStandings.map((player, i) => `
                    <div class="flex justify-between items-center p-4 rounded-lg ${
                      i === 0 ? 'bg-yellow-100 border-2 border-yellow-400' :
                      i === 1 ? 'bg-gray-200' :
                      i === 2 ? 'bg-orange-100' : 'bg-white'
                    } ${player.id === state.playerId ? 'ring-2 ring-indigo-400' : ''}">
                      <div class="flex items-center gap-4">
                        <span class="text-3xl">
                          ${i === 0 ? '🥇' : i === 1 ? '🥈' : i === 2 ? '🥉' : `#${i + 1}`}
                        </span>
                        <div>
                          <span class="font-medium text-lg">${player.name}</span>
                          ${player.id === state.playerId ? '<span class="text-xs text-indigo-600 ml-2">(You)</span>' : ''}
                          <div class="text-sm text-gray-500">
                            Total Production: ${player.totalProduction} units
                          </div>
                        </div>
                      </div>
                      <div class="text-right">
                        <div class="text-2xl font-bold ${player.totalProfit > 0 ? 'text-green-600' : 'text-red-600'}">
                          $${player.totalProfit.toFixed(0)}
                        </div>
                        <div class="text-sm text-gray-500">total profit</div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>

              <div class="bg-gray-50 rounded-lg p-6 mb-8">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">📈 Round-by-Round Summary</h3>
                <div class="overflow-x-auto">
                  <table class="w-full">
                    <thead>
                      <tr class="border-b-2 border-gray-300">
                        <th class="text-left py-3 px-2">Player</th>
                        ${[1, 2, 3].map(i => `
                          <th class="text-center py-3 px-2">Round ${i}</th>
                        `).join('')}
                        <th class="text-right py-3 px-2 font-bold">Total</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${finalStandings.map(player => `
                        <tr class="border-b border-gray-200 ${player.id === state.playerId ? 'bg-indigo-50' : ''}">
                          <td class="py-3 px-2 font-medium">
                            ${player.name}
                            ${player.id === state.playerId ? '<span class="text-xs text-indigo-600">(You)</span>' : ''}
                          </td>
                          ${player.rounds.map(r => `
                            <td class="text-center py-3 px-2">
                              <div class="text-xs text-gray-500">${r.production} units</div>
                              <div class="font-medium ${r.profit > 0 ? 'text-green-600' : 'text-red-600'}">
                                $${r.profit.toFixed(0)}
                              </div>
                            </td>
                          `).join('')}
                          <td class="text-right py-3 px-2 font-bold ${player.totalProfit > 0 ? 'text-green-600' : 'text-red-600'}">
                            $${player.totalProfit.toFixed(0)}
                          </td>
                        </tr>
                      `).join('')}
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="bg-purple-50 rounded-lg p-6 border-l-4 border-purple-500 mb-6">
                <h3 class="text-xl font-bold text-purple-900 mb-3">💡 Key Insights</h3>
                <div class="space-y-3 text-gray-700">
                  <p>
                    <strong>Total Production:</strong> Across all ${TOTAL_ROUNDS} rounds, participants produced 
                    a combined <strong>${totalProductionAllRounds} units</strong> 
                    (average ${avgProductionPerRound.toFixed(1)} units per round).
                  </p>
                  <p>
                    <strong>Electricity Costs:</strong> The collective production created an average electricity bill of 
                    <strong>$${avgBillPerRound.toFixed(0)}</strong> per firm per round. 
                    ${avgBillPerRound > BASE_BILL * 1.5 ? 
                      `This is <strong>${((avgBillPerRound / BASE_BILL - 1) * 100).toFixed(0)}% higher</strong> than the base cost, 
                      showing how overproduction increased everyone's costs!` : 
                      'Production was relatively moderate, keeping shared costs under control.'}
                  </p>
                  <p>
                    <strong>The Externality:</strong> Each unit of production added 
                    <strong>$${EXTERNAL_COST_PER_UNIT}</strong> to everyone's electricity bill. 
                    When firms pursued their own profits without considering these external costs, 
                    it created a <strong>negative externality</strong> that affected the entire community.
                  </p>
                  <p>
                    <strong>Real-World Application:</strong> This mirrors real situations like pollution, traffic congestion, 
                    or resource depletion, where individual choices create costs for society. 
                    Policy solutions might include taxes (like a carbon tax), regulations, or community cooperation agreements.
                  </p>
                </div>
              </div>

              ${state.isInstructor ? `
                <button onclick="goHome()" 
                  class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-semibold">
                  Back to Home
                </button>
              ` : `
                <div class="text-center text-gray-500">
                  <p>Thank you for participating! You can close this window now.</p>
                </div>
              `}
            </div>
          </div>
        </div>
      `;
    }

    // Initial render
    render();
  </script>
</body>
</html>